name: X Media Archive to Google Photos (Full Run)

on:
  workflow_dispatch:
    inputs:
      users:
        description: "请输入需要全量归档的 X/Twitter 用户名 (逗号分隔，如: OkazuSera,tanima_aiart)"
        required: true
        type: string

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      users_matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Matrix
        id: set-matrix
        run: |
          # 去除所有空格，处理类似 "user1, user2" 的输入
          CLEAN_USERS=$(echo "${{ github.event.inputs.users }}" | tr -d ' ' )
          # 利用 jq 将逗号分隔字符串转化为每 5 个一组的 JSON 数组块 (丢弃空元素)
          JSON_ARRAY=$(jq -Rc 'split(",") | map(select(length > 0)) | _nwise(5) | map(join(","))' <<< "$CLEAN_USERS")
          echo "Generated matrix JSON: $JSON_ARRAY"
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  archive_google_full:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 即使某个用户的抓取任务报错，也不阻塞中断其他用户的抓取任务
      matrix:
        user: ${{ fromJson(needs.setup-matrix.outputs.users_matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Playwright Browsers
        run: |
          playwright install chromium

      - name: Run Full Google Photos Archiver for ${{ matrix.user }}
        env:
          TWITTER_COOKIES: ${{ secrets.TWITTER_COOKIES }}
          GOOGLE_PHOTOS_TOKEN: ${{ secrets.GOOGLE_PHOTOS_TOKEN }}
        run: |
          IFS=',' read -ra ADDR <<< "${{ matrix.user }}"
          for u in "${ADDR[@]}"; do
            echo "Processing user: $u"
            python src/tasks/task_google_full.py --users "$u"
          done
